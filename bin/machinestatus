#! /usr/bin/env ruby
# coding: utf-8

USAGE = <<HERE
machinestatus HostA HostB
machinestatus -g GroupA GroupB #-g option interprets as group name
HERE

require "pp"
require "optparse"
require "rubygems"
require "comana"
require "highline"

HIGHLINE = HighLine.new

##Analyze options
OPTIONS = {}
op = OptionParser.new
op.on("-a", "--ping-alive", "Check only alive using ping"){OPTIONS[:ping] = true}
#op.on("-t", "--top"       , "Info from top.     "){OPTIONS[:top     ] = true}
#op.on("-p", "--ps"        , "Info from ps.      "){OPTIONS[:ps      ] = true}
op.on("-n", "--pbsnodes"  , "Info from pbsnodes."){OPTIONS[:pbsnodes] = true}
#op.on("-d", "--dmesg"     , "Info from dmesg.   "){OPTIONS[:dmesg   ] = true}

op.on("-g", "--group"    , "Indicate group of hosts"    ){OPTIONS[:group] = true}
op.parse!(ARGV)


##Select hosts
cs = Comana::ClusterSetting.load_file
groups = {}
cs.groups.each do |key, val|
  cluster = key
  groups[key] = val["members"]
end

hs = Comana::HostSelector.new groups
if OPTIONS[:group]
  hosts = []
  ARGV.each do |group|
    hosts << hs.select_group(group)
  end
  hosts.flatten!
else
  hosts = ARGV
end
hosts = hs.select_all if ARGV.empty?

#pp hosts;exit

##Collect information
Thread.abort_on_exception = true
results = {}
threads = {}
hosts.each do |host|
  threads[host] = Thread.start do
    results[host] = {}
    if OPTIONS[:ping]
      results[host][:ping] = Comana::HostInspector::Ping.new host
    end
    if OPTIONS[:pbsnodes]
      results[host][:pbsnodes] = Comana::HostInspector::Pbsnodes.new(host, cs.pbs_server)
    end
  end
end

threads.each do |host, thread|
  print "Waiting for #{host}...\n"
  thread.join              # wait until all processes are completed
end

##Show
results.keys.sort.each do |host|
  printf("%9s: ", host)
  #pp results[host]
  if OPTIONS[:ping]
    state = HIGHLINE.color("dead", :red)
    state = "alive" if results[host][:ping].alive?
    printf("%5s", state)
  end
  if OPTIONS[:pbsnodes]
    printf("%10s ", results[host][:pbsnodes].state            )
    printf("%1s ", results[host][:pbsnodes].np               )
    printf("%2s ", results[host][:pbsnodes].properties       )
    printf("%10s ", results[host][:pbsnodes].ntype            )
    printf("%1s ", results[host][:pbsnodes].gpus             )

    printf("%10s " , results[host][:pbsnodes].status["rectime"  ])
    printf("%2s " , results[host][:pbsnodes].status["varattr"  ])
    printf("%4s " , results[host][:pbsnodes].status["jobs"     ][0..3])
    printf("%4s " , results[host][:pbsnodes].status["state"    ])
    printf("%10s " , results[host][:pbsnodes].status["netload"  ])
    printf("%10s " , results[host][:pbsnodes].status["gres"     ])
    printf("%10s " , results[host][:pbsnodes].status["loadave"  ])
    printf("%10s " , results[host][:pbsnodes].status["ncpus"    ])
    printf("%10s " , results[host][:pbsnodes].status["physmem"  ])
    printf("%10s " , results[host][:pbsnodes].status["availmem" ])
    printf("%10s " , results[host][:pbsnodes].status["totmem"   ])
    printf("%10s " , results[host][:pbsnodes].status["idletime" ])
    printf("%10s " , results[host][:pbsnodes].status["nusers"   ])
    printf("%10s " , results[host][:pbsnodes].status["nsessions"])
    printf("%10s " , results[host][:pbsnodes].status["sessions" ])
    printf("%10s " , results[host][:pbsnodes].status["uname"    ])
    printf("%10s " , results[host][:pbsnodes].status["opsys"    ])
    #results[host][:pbsnodes].status[""]
  end
  puts
end
